<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Consultar Registros Técnicos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Adiciona a centralização para o conteúdo do formulário de filtro */
        .filtro-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .icones-consulta {
            /* Alinha os ícones à direita para ficarem mais próximos da tabela */
            display: flex;
            gap: 10px;
            float: right;
            margin-bottom: 15px; /* Espaço entre os ícones e a tabela */
        }
        /* Estilos de impressão */
        @media print {
            .filtro-container, .navbar, .icones-consulta {
                display: none; /* Esconde filtros e botões na impressão */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Consulta de Registros</h1>
        
        <form method="GET" action="{{ url_for('consultar_registro') }}" class="filtro-container">
            <div>
                <label for="posto">Posto:</label>
                <select name="posto" id="posto" class="form-control">
                    <option value="Todos">Todos</option>
                    {% for posto in postos %}
                        <option value="{{ posto }}" {% if filtro_posto == posto %}selected{% endif %}>{{ posto }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="data">Data:</label>
                <input type="date" name="data" id="data" class="form-control" value="{{ filtro_data or '' }}">
            </div>
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="{{ url_for('consultar_registro') }}" class="btn btn-secondary">Limpar Filtros</a>
        </form>

        <div class="icones-consulta">
            <a href="#" onclick="window.print()" title="Imprimir Consulta" class="btn btn-sm btn-light">
                <i class="fas fa-print"></i> Imprimir
            </a>
            <a id="btnExportar" href="#" title="Exportar para Excel" class="btn btn-sm btn-success">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
        </div>
        <div style="clear: both;"></div> <table id="tabelaRegistros">
            <thead>
                <tr>
                    <th>Posto</th>
                    <th>Coleta de imagem?</th>
                    <th>Data</th>
                    <th>Início</th>
                    <th>Término</th>
                    <th>Procedimento Realizado</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Função para carregar os dados via AJAX
            function carregarRegistros() {
                const posto = $('#posto').val();
                const data = $('#data').val();
                
                $.getJSON("{{ url_for('registros_json') }}", { posto: posto, data: data })
                .done(function(registros) {
                    const tbody = $('#tabelaRegistros tbody');
                    tbody.empty(); // Limpa registros existentes

                    if (registros.length === 0) {
                        tbody.append('<tr><td colspan="6">Nenhum registro encontrado.</td></tr>');
                        return;
                    }

                    registros.forEach(function(r) {
                        const row = `
                            <tr>
                                <td>${r.posto}</td>
                                <td>${r.computador_coleta.toUpperCase()}</td>
                                <td>${r.data}</td>
                                <td>${r.hora_inicio}</td>
                                <td>${r.hora_termino}</td>
                                <td class="procedimento-resumo" title="${r.procedimento_completo}">${r.procedimento_resumo}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    $('#tabelaRegistros tbody').empty().append(`<tr><td colspan="6">Erro ao carregar dados: ${textStatus}</td></tr>`);
                });
            }

            // Ativa o botão de Exportar
            $('#btnExportar').click(function(e) {
                e.preventDefault();
                const posto = $('#posto').val();
                const data = $('#data').val();
                let url = "{{ url_for('exportar_registros') }}";
                
                // Anexa os filtros atuais à URL de exportação
                const params = new URLSearchParams();
                if (posto && posto !== 'Todos') {
                    params.append('posto', posto);
                }
                if (data) {
                    params.append('data', data);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                window.location.href = url;
            });

            // Carrega os registros na inicialização da página
            carregarRegistros();
        });
    </script>
</body>
</html>
