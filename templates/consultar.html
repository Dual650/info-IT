<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Registros Técnicos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Estilos específicos desta página para o layout */
        .container {
            max-width: 95%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center; /* ALINHA ITENS AO CENTRO VERTICALMENTE */
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .filtro-container {
            display: flex;
            flex-wrap: wrap; 
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .filtro-item {
            display: flex;
            flex-direction: column;
        }
        .btn-acao {
            background: none;
            border: 1px solid #ccc;
            padding: 5px 8px; 
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            color: #333;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* REMOVIDO height: 35px; - O alinhamento será feito pelo align-items do header-section */
        }
        .btn-acao:hover {
            background-color: #e9e9e9;
        }
        /* Ajuste do tamanho dos ícones */
        .btn-acao i {
            font-size: 1.0em; 
        }
        /* Estilos de impressão */
        @media print {
            .filtro-container, .header-section, .btn-primary, .icones-consulta {
                display: none; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header-section">
            <h2>Consulta de Registros Técnicos</h2>
            <div class="icones-consulta">
                <a href="#" onclick="window.print()" title="Imprimir Consulta" class="btn-acao">
                    <i class="fas fa-print"></i>
                </a>
                <a id="btnExportar" href="#" title="Exportar para Excel" class="btn-acao">
                    <i class="fas fa-file-excel" style="color: green;"></i>
                </a>
            </div>
        </div>
        
        <form method="GET" action="{{ url_for('consultar_registro') }}" class="filtro-container">
            
            <div class="filtro-item">
                <label for="posto">Posto:</label>
                <select name="posto" id="posto" class="form-control">
                    <option value="Todos">Todos</option>
                    {% for posto in postos %}
                        <option value="{{ posto }}" {% if filtro_posto == posto %}selected{% endif %}>{{ posto }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filtro-item">
                <label for="coleta">Coleta de imagem?:</label>
                <select name="coleta" id="coleta" class="form-control">
                    <option value="Todos" {% if filtro_coleta == 'Todos' %}selected{% endif %}>Todos</option>
                    <option value="SIM" {% if filtro_coleta == 'SIM' %}selected{% endif %}>SIM</option>
                    <option value="NÃO" {% if filtro_coleta == 'NÃO' %}selected{% endif %}>NÃO</option>
                </select>
            </div>

            <div class="filtro-item">
                <label for="data">Data:</label>
                <input type="date" name="data" id="data" class="form-control" value="{{ filtro_data or '' }}">
            </div>
            
            <div class="filtro-item" style="flex-direction: row; gap: 10px;">
                <button type="submit" class="btn-primary">Filtrar</button>
            </div>
        </form>

        <div class="table-responsive">
            <table id="tabelaRegistros">
                <thead>
                    <tr>
                        <th>Posto</th>
                        <th>Coleta de imagem?</th>
                        <th>Data</th>
                        <th>Horário de Início</th>
                        <th>Horário de Término</th>
                        <th>Procedimento Realizado</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        $(document).ready(function() {
            // Função para carregar os dados via AJAX
            function carregarRegistros() {
                const posto = $('#posto').val();
                const data = $('#data').val();
                const coleta = $('#coleta').val();

                $.getJSON("{{ url_for('registros_json') }}", { posto: posto, data: data, coleta: coleta })
                .done(function(registros) {
                    const tbody = $('#tabelaRegistros tbody');
                    tbody.empty();

                    if (registros.length === 0) {
                        tbody.append('<tr><td colspan="6">Nenhum registro encontrado.</td></tr>');
                        return;
                    }

                    registros.forEach(function(r) {
                        // Aplica a classe de negrito na coluna Coleta de Imagem
                        const coleta_class = 'coleta-negrito'; 
                        
                        const row = `
                            <tr>
                                <td>${r.posto}</td>
                                <td class="${coleta_class}">${r.computador_coleta.toUpperCase()}</td>
                                <td>${r.data}</td>
                                <td>${r.hora_inicio}</td>
                                <td>${r.hora_termino}</td>
                                <td class="procedimento-resumo" title="${r.procedimento_completo}">${r.procedimento_resumo}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    $('#tabelaRegistros tbody').empty().append(`<tr><td colspan="6">Erro ao carregar dados: ${textStatus}</td></tr>`);
                });
            }

            // Ativa o botão de Exportar
            $('#btnExportar').click(function(e) {
                e.preventDefault();
                const posto = $('#posto').val();
                const data = $('#data').val();
                const coleta = $('#coleta').val(); 
                let url = "{{ url_for('exportar_registros') }}";
                
                const params = new URLSearchParams();
                if (posto && posto !== 'Todos') {
                    params.append('posto', posto);
                }
                if (data) {
                    params.append('data', data);
                }
                if (coleta && coleta !== 'Todos') { 
                    params.append('coleta', coleta);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                window.location.href = url;
            });

            // Carrega os registros na inicialização da página
            carregarRegistros();
        });
    </script>
</body>
</html>
